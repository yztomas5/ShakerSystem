-- Module: ShakerInventory.lua
-- Ubicación: ReplicatedStorage.Modules.Utils.ShakerLogic

local Players = game:GetService("Players")

local ShakerInventory = {}

-- Obtener el inventario de ingredientes de un shaker
function ShakerInventory.GetIngredientFolders(player, shakerNumber)
	local playerShakers = player:FindFirstChild("Shakers")
	if not playerShakers then return {} end

	local shakerFolder = playerShakers:FindFirstChild(tostring(shakerNumber))
	if not shakerFolder then return {} end

	local folders = {}
	for _, child in ipairs(shakerFolder:GetChildren()) do
		if child:IsA("Folder") then
			table.insert(folders, child)
		end
	end
	return folders
end

-- Contar ingredientes en un shaker
function ShakerInventory.CountIngredients(player, shakerNumber)
	return #ShakerInventory.GetIngredientFolders(player, shakerNumber)
end

-- Verificar si el shaker está lleno
function ShakerInventory.IsFull(player, shakerNumber, maxIngredients)
	return ShakerInventory.CountIngredients(player, shakerNumber) >= maxIngredients
end

-- Verificar si el shaker está vacío
function ShakerInventory.IsEmpty(player, shakerNumber)
	return ShakerInventory.CountIngredients(player, shakerNumber) == 0
end

-- Buscar un ingrediente específico en el inventario del jugador
function ShakerInventory.FindIngredientInPlayerInventory(player, toolName, toolId)
	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return nil end

	local ingredients = inventory:FindFirstChild("Ingredients")
	if not ingredients then return nil end

	for _, ingredientFolder in ipairs(ingredients:GetChildren()) do
		if ingredientFolder:IsA("Folder") and ingredientFolder.Name == toolName then
			local idValue = ingredientFolder:FindFirstChild("Id")
			if idValue and idValue:IsA("IntValue") and idValue.Value == toolId then
				return ingredientFolder
			end
		end
	end

	return nil
end

-- Buscar un gear específico en el inventario del jugador (NUEVO para Energizing)
function ShakerInventory.FindGearInPlayerInventory(player, gearName, toolId)
	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return nil end

	local gears = inventory:FindFirstChild("Gears")
	if not gears then return nil end

	for _, gearFolder in ipairs(gears:GetChildren()) do
		if gearFolder:IsA("Folder") and gearFolder.Name == gearName then
			local idValue = gearFolder:FindFirstChild("Id")
			if idValue and idValue:IsA("IntValue") and idValue.Value == toolId then
				return gearFolder
			end
		end
	end

	return nil
end

-- Añadir ingrediente al shaker
function ShakerInventory.AddIngredient(player, shakerNumber, ingredientFolder)
	local playerShakers = player:FindFirstChild("Shakers")
	if not playerShakers then return false end

	local shakerFolder = playerShakers:FindFirstChild(tostring(shakerNumber))
	if not shakerFolder then return false end

	-- BORRAR el Id antes de mover al shaker
	local idValue = ingredientFolder:FindFirstChild("Id")
	if idValue then
		idValue:Destroy()
	end

	ingredientFolder.Parent = shakerFolder
	task.wait(0.1)

	return ingredientFolder.Parent == shakerFolder
end

-- Remover ingrediente del shaker (devolver al inventario)
function ShakerInventory.RemoveIngredient(player, shakerNumber)
	local playerShakers = player:FindFirstChild("Shakers")
	if not playerShakers then return false end

	local shakerFolder = playerShakers:FindFirstChild(tostring(shakerNumber))
	if not shakerFolder then return false end

	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return false end

	local ingredients = inventory:FindFirstChild("Ingredients")
	if not ingredients then
		ingredients = Instance.new("Folder")
		ingredients.Name = "Ingredients"
		ingredients.Parent = inventory
	end

	local ingredientFolder = shakerFolder:FindFirstChildOfClass("Folder")
	if not ingredientFolder then return false end

	local ingredientName = ingredientFolder.Name

	-- Ya no tiene Id, así que simplemente moverlo de vuelta
	ingredientFolder.Parent = ingredients
	task.wait(0.1)
	return ingredientFolder.Parent == ingredients
end

-- Devolver todos los ingredientes del shaker al inventario
function ShakerInventory.ReturnAllIngredients(player, shakerNumber)
	local playerShakers = player:FindFirstChild("Shakers")
	if not playerShakers then return false end

	local shakerFolder = playerShakers:FindFirstChild(tostring(shakerNumber))
	if not shakerFolder then return false end

	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return false end

	local ingredients = inventory:FindFirstChild("Ingredients")
	if not ingredients then
		ingredients = Instance.new("Folder")
		ingredients.Name = "Ingredients"
		ingredients.Parent = inventory
	end

	for _, child in ipairs(shakerFolder:GetChildren()) do
		if child:IsA("Folder") then
			child.Parent = ingredients
		end
	end

	return true
end

return ShakerInventory
